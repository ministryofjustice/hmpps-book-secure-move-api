---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: weekly-cancelled-court-moves-report
spec:
  schedule: "30 6 * * 1"
  concurrencyPolicy: "Forbid"
  successfulJobsHistoryLimit: 5
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 345600
      backoffLimit: 0
      activeDeadlineSeconds: 7200
      template:
        spec:
          serviceAccountName: "book-a-secure-move-api"
          containers:
            - name: weekly-cancelled-court-moves
              image: "ghcr.io/ministryofjustice/hmpps-devops-tools:latest"
              command: ["bash", "/scripts/run-report.sh"]
              volumeMounts:
                - name: report-scripts
                  mountPath: /scripts
                  readOnly: true
                - name: report-sql
                  mountPath: /report
                  readOnly: false
              env:
                - name: DB_INSTANCE
                  valueFrom:
                    secretKeyRef:
                      name: read-rds-instance-hmpps-book-secure-move-api-production
                      key: url
                - name: NOTIFY_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: hmpps-book-secure-move-api-secrets-production
                      key: govuk_notify_api_key
                - name: REPORT_START
                  valueFrom:
                    configMapKeyRef:
                      name: weekly-cancelled-court-moves-config
                      key: from-date
                - name: REPORT_END
                  valueFrom:
                    configMapKeyRef:
                      name: weekly-cancelled-court-moves-config
                      key: to-date
                - name: EMAIL_SUBJECT
                  valueFrom:
                    configMapKeyRef:
                      name: weekly-cancelled-court-moves-config
                      key: subject
                - name: EMAIL_BODY
                  valueFrom:
                    configMapKeyRef:
                      name: weekly-cancelled-court-moves-config
                      key: body
                - name: FILENAME
                  valueFrom:
                    configMapKeyRef:
                      name: weekly-cancelled-court-moves-config
                      key: filename
                - name: RETENTION_PERIOD
                  valueFrom:
                    configMapKeyRef:
                      name: weekly-cancelled-court-moves-config
                      key: retention
                - name: EMAIL_ADDRESSEES
                  valueFrom:
                    configMapKeyRef:
                      name: weekly-cancelled-court-moves-config
                      key: recipients
                - name: CONFIRM_EMAIL
                  valueFrom:
                    configMapKeyRef:
                      name: weekly-cancelled-court-moves-config
                      key: confirm_email
                - name: AWS_DEFAULT_REGION
                  value: "eu-west-2"
          restartPolicy: "Never"
          volumes:
            - name: report-scripts
              configMap:
                name: automated-reports-scripts
                defaultMode: 0755
                items:
                  - key: "notify-token.sh"
                    path: "notify-token.sh"
                  - key: "run-report.sh"
                    path: "run-report.sh"
                  - key: "placeholders"
                    path: "placeholders.sh"
            - name: report-sql
              configMap:
                name: weekly-cancelled-court-moves-config
                defaultMode: 0755
                items:
                  - key: "report_sql"
                    path: "report.sql"