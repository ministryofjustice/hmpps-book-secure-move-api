# hmpps-book-secure-move-api

This repository contains the backend API for the Book A Secure Move platform.

## Ruby versions and other dependencies

We typically use [asdf](https://asdf-vm.com/#/) or [rbenv](https://github.com/rbenv/rbenv) to install changing versions of ruby via the .ruby-version file.

If you have `rbenv` installed you can run `rbenv install $(cat .ruby-version)`.
If you have `asdf` with the ruby plugin installed you can run `asdf install`.

* System dependencies
  * postgres
  * redis

## Development Environment setup

To setup the local development environment:

1. Install Postgres and Redis if needed.
2. Clone this Git repository.
3. Run `bin/setup` to install Rubygem dependencies, then setup local
   test and development databases etc.

### Running the application

After setup should then be able to run the local Web server:

```bash
bundle exec rails server
```

### Creating client credentials

The application implements OAuth2 client credentials flow. To generate new application client credentials, use the following Rake task:

```bash
bundle exec rake auth:create_client_application NAME=test
```

Please note; the automatically generated secret is hashed and cannot be retrieved later.

To get an access token with client credentials flow, do a POST request to the `/oauth/token` endpoint:

```
POST /oauth/token
Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW
Content-Type: application/x-www-form-urlencoded;charset=UTF-8
grant_type=client_credentials
```

The Authorization header includes the encoded credentials for the client, represented as a Base64-encoded (without line breaks) string of the form `<client_id>:<client_secret>`.

You will receive a JSON payload containing an `access_token` and `expires_in`. You can then sign following requests with the following header:

```
Authorization: Bearer <access_token>
```

The `expires_in` response denotes the time in seconds from the token request after which the token will expire.

### Running tests

We use RSpec for testing, to run the tests:

```bash
bundle exec rspec
```

We use Rubocop for code linting, to run the checks:

```bash
bundle exec rubocop
```

### Create fake data

To create fake data to use for testing and in a development environment run:

```
bundle exec rails fake_data:recreate_all
```

**WARNING:** This will delete all existing data

### Create reference data

To create reference data (seed data) needed in production run the
following rake task:

```bash
bundle exec rake reference_data:create_all
```

Some of these tasks pull data from NOMIS and therefore require
environment variables configured with the relevant security credentials.

These tasks are designed to be non-destructive. They can be run multiple
times and will only modify data if the original data source has changed.

### Populate Framework data

To create a framework and populate it's questions run the following rake task:

```bash
bundle exec rake frameworks:populate_data
```

This will pull in all tagged versions from the [Framework repository](https://github.com/ministryofjustice/hmpps-book-secure-move-frameworks) and persist the Framework Questions under the Framework version extracted from the Git tag. 

Alternatively, to specify a local Framework and version run the task with the following options:

```bash
bundle exec rake frameworks:populate_data['/path/to/hmpps-book-secure-move-frameworks/frameworks','1.1.1']
```

The path to the frameworks folder and the semantic version can be specified.

## Documentation

### Database schema

A database schema diagram can be generated by running:

```bash
bundle exec rake erd
```

This will output a file named `erd.pdf`; this file should not be added to git as it can be generated on demand.

Graphviz also needs to be installed (`brew install graphviz`) for this to work. For more details see: https://github.com/voormedia/rails-erd

## Continuous Integration

We use Circle CI for continuous integration: running tests, updating the
Docker image, pushing code staging:

[![CircleCI](https://circleci.com/gh/ministryofjustice/hmpps-book-secure-move-api)](https://circleci.com/gh/ministryofjustice/hmpps-book-secure-move-api)

## Deployment

This application is deployed to [Cloud Platform](https://user-guide.cloud-platform.service.justice.gov.uk/).

Currently we have a `dev`, `staging`, `uat`, `preprod` and `production` environment on Cloud
Platform with the following namespace names:

* hmpps-book-secure-move-api-dev
* hmpps-book-secure-move-api-staging
* hmpps-book-secure-move-api-uat
* hmpps-book-secure-move-api-preprod
* hmpps-book-secure-move-api-production

`dev` and `staging` environments are automatically deployed on successful builds of the
`master` branch on Circle CI.

`preprod`, `uat` and `production` can be deployed by generating a new tag
following [semantic versioning](https://semver.org/) pointing to the current commit.

Tagged deploys are gated for the `production` environment and require an approval. This is typically done after
a review from a product owner where reasonable and if a hotfix is not necessary/
the workflow.

You'll want to login to CircleCI and navigate to the project build list to find the build that needs approving.

## Running in docker-compose locally.

You can run the build container locally using docker-compose.

```bash
# start the docker-compose stack in the background.
docker-compose up -d

# You can follow the logs by doing
docker-compose logs -f
```

You can force rebuilding the container with:

```bash
docker-compose build
```

You can review swagger documentation by navigating to `http://localhost:3000/api-docs/index.html`

If your database is fresh or was reset, you need to generate new application client credentials.
You can do this by running the respecive rake task inside the compose stack.

```bash
docker exec -it hmpps-book-secure-move-api_web_1 bundle exec rake auth:create_client_application NAME=test
```

The docker-compose stack also exposes the Postgres port to the host. You can update the reference data with:

```bash
export DATABASE_URL=postgresql://postgres:postgres@localhost:5432/hmpps-book-secure-move-api
bundle exec rake reference_data:create_all
```
